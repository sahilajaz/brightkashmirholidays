var EntityPreviewConfig,__extends,EntityPanePreview;(function(n){var u="a",i,r,t;n.DivTag="div";n.ClickEvent="click";n.MouseUpEvent="mouseup";n.SidParamName="sid";n.AnchorHookName="h";n.HoverHookName="hover-data";n.SidAttribute="data-sid";n.HideClassName="b_hidden";n.LogEventType="EPWindow";n.LogFeatureName="EntityPreview";n.PreviewWindowLinkTrait="&epw=1";n.EventShow="Show";n.EventHide="Hide";n.PixelSuffix="px";n.EpvCaptionClassName="epv_caption";i=function(){function i(n,t){this._container=n;this._popOver=t}return i.prototype.initLinks=function(){var e,f,i,r,o,s;if(this._container!=null)for(e=this._container.getElementsByTagName(u),f=0;f<e.length;f++)if((i=e[f],r=t.decodeUrl(i.href),r)&&(o=i.getAttribute(n.HoverHookName),s=i.getAttribute(n.SidAttribute),i.className.indexOf("b_moreLink")===-1&&r!=null&&r.search(/\Wsid:"/i)!==-1&&(r.search("&eeptype=Entity")!==-1||r.search(/&eeptype=\w+?/i)===-1)||o||s)){if(o==="-")continue;this.hookHandlers(i)}},i.prototype.showPreview=function(n){n!=null&&this._popOver.show(n)},i.prototype.hookHandlers=function(){},i}();n.EntityPreviewBaseController=i;r=function(){function i(){this._cache={}}return i.prototype.GetContent=function(n,i,r,u,f){var s=this,e,o;this._popOver=r;e=f?f:t.getSidFromUrl(n);!u&&e&&e in this._cache?(this.renderContent(this._cache[e],e),this._cache[e]==null&&t.Log("CacheFail",e)):(o=this.buildLink(n,e,i),e=u?null:e,sj_ajax(o,{callback:function(n,t){return s.requestCallback(e,n,t)}}))},i.prototype.requestCallback=function(n,i,r){n?i?(r.request.status===200?this._cache[n]=r:(this._cache[n]=null,t.Log("Fail",n)),this.renderContent(r,n)):(this._cache[n]=null,this.renderContent(this._cache[n],n),t.Log("Fail",n)):i&&r.request.status===200&&this.renderContent(r,null)},i.prototype.renderContent=function(i,r){var u=sj_ce(n.DivTag,null);i&&(i.appendTo(u),u.innerHTML==""&&t.Log("NoContent",r));this._popOver.displayContent(u,r)},i.prototype.buildLink=function(n,t,i){var r,f,e,o,u;return t?(f=this.parseQuery(n),r="/entitypreview?q="+(f?f:"query")+("&entityid="+t)+("&psid="+i)):r=n,EntityPreviewConfig&&EntityPreviewConfig.featureList&&(r+="&features="+EntityPreviewConfig.featureList),EntityPreviewConfig.testHooks||(e=this._popOver.hValue(),o="",e&&(u=/ID=(\w+?),(\d+)(\.\d+)?/i.exec(e),u&&(o="".concat(u[1],".").concat(u[2]))),r+="&IG="+_G.IG+"&iid="+o),r},i.prototype.parseQuery=function(n){if(!n)return null;var t=/search\?q=(.+?)[&$]/.exec(n);return t?t[1]:null},i}();n.EntityPreviewContentLoader=r;t=function(){function t(){}return t.decodeUrl=function(n){try{return decodeURIComponent(n)}catch(t){return null}},t.getSidFromUrl=function(n){var r=t.decodeUrl(n),i;return r?(i=/\Wsid:"(.+?)"/i.exec(t.decodeUrl(n)),i?i[1]:null):null},t.getEntityNameFromUrl=function(n){var r=t.decodeUrl(n),i;return r?(i=/[&?]q=(.+?)&/i.exec(t.decodeUrl(n)),i?i[1].replace(/\+/g," "):null):null},t.Log=function(t,i){Log.Log(n.LogEventType,t,n.LogFeatureName,!1,n.SidParamName,i)},t.LogCiHover=function(n,t,i){var u,f,r,e,o;if(n){u=null;f=null;t&&(r=t.split(","),r&&r.length===2&&(f=r[1],u=r[0].toUpperCase().indexOf("SERP")!==-1?"SERP":null));e='{"T":"CI.Hover","AppNS":"'.concat(u,'","K":"').concat(f,'","Name":"EntityPreview","HType":"').concat(n,'","TS":').concat(sb_gt(),',"FID":"').concat(i,'"}');o=new Image;try{o.src="/fd/ls/ls.gif?IG=".concat(_G.IG,"&Type=Event.ClientInst&DATA=").concat(e,"&log=UserEvent")}catch(s){}}},t}();n.Util=t})(EntityPanePreview||(EntityPanePreview={}));__extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}if(typeof i!="function"&&i!==null)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),function(n){function k(n){if(!n)return null;return n.nextElementSibling&&n.nextElementSibling.className.indexOf(c)>=0?n.nextElementSibling.getAttribute("psid"):""}function d(t,r,u,f,e){r===void 0&&(r=undefined);u===void 0&&(u=!0);f===void 0&&(f=!1);e===void 0&&(e=null);var o=[];sj_evt.bind("EPReady",function(){var s=_d.getElementsByClassName(t),l,a,c,h,v;if(s!=null&&s.length!=0)for(l=new n.EntityPreviewContentLoader,h=0;h<s.length;h++)v=k(s[h]),a=new b(i,v,l,t,f,e),c=new p(s[h],a,r,u),c.initLinks(),o.push(c)},!0);sj_evt.bind("onCarouselFetch",function(){var n,t,i;if(o&&o.length>0)for(n=0,t=o;n<t.length;n++)i=t[n],i.initLinks()},!0)}var i="tpPreview",r="mouseover",u="mouseout",e="focus",o="blur",s="scroll",h="epv_content",c="epv_meta",l="epvRup",a="epvLup",v="epvRdown",y="epvLdown",t="hidden",f="_blank",p=function(t){function i(n,i,r,u){var f,e;return r===void 0&&(r=undefined),u===void 0&&(u=!0),f=t.call(this,n,i)||this,f.debounceTime=1e3,f.mouseOverHandler=function(n){sj_pd(n);sj_sp(n);f._popOver.setTargetElement(n.currentTarget);u&&f.showPreview(n.currentTarget);r&&(sb_ct(e),e=sb_st(r,f.debounceTime))},f.mouseOutHandler=function(n){n.currentTarget&&(n.currentTarget.setAttribute("aria-describedby",""),sj_pd(n),sj_sp(n),f._popOver.setTargetElement(null),u&&f._popOver.hide(),r&&sb_ct(e))},f.mouseClickHandler=function(n){n.currentTarget&&(n.currentTarget.setAttribute("aria-describedby",""),f._popOver.setTargetElement(null),u&&f._popOver.hide(),r&&sb_ct(e))},f}return __extends(i,t),i.prototype.hookHandlers=function(t){if(sj_be(t,r,this.mouseOverHandler),sj_be(t,e,this.mouseOverHandler),sj_be(t,u,this.mouseOutHandler),sj_be(t,o,this.mouseOutHandler),sj_be(t,n.ClickEvent,this.mouseClickHandler),t.removeAttribute("title"),t.children&&t.children.length>0){var f=t.children[0],i,s=!1;f.tagName=="IMG"?i=f:f.tagName=="DIV"&&f.className&&f.className.indexOf("rms_img")>=0&&f.children&&f.children.length>0&&f.children[0].tagName=="IMG"&&(i=f.children[0],s=!0);i&&i.className&&typeof i.className.indexOf=="function"&&i.className.indexOf("rms_img")>=0&&(!i.hasAttribute("aria-label")&&i.title&&i.setAttribute("aria-label",i.title),i.removeAttribute("title"),s&&f.removeAttribute("title"))}},i}(n.EntityPreviewBaseController),w=function(){function n(){this.mouseOnLink=!1;this.mouseOnPreviewWindow=!1;this.windowVisible=!1}return n.prototype.shouldShow=function(){return this.mouseOnLink&&!this.mouseOnPreviewWindow&&(!this.windowVisible||this.windowVisible&&!this.sameEntity)},n.prototype.shouldHide=function(){return this.windowVisible&&!this.mouseOnPreviewWindow&&(!this.sameEntity||this.sameEntity&&!this.mouseOnLink)},n}(),b=function(){function e(n,t,i,r,u,f){u===void 0&&(u=!1);f===void 0&&(f=null);this.EventDelay=500;this.D2Timeout=2e3;this.D5Timeout=5e3;this._loader=i;this._psid=t;this._containerClassName=r?r:"NA";this.forceShowingUnderTarget=u;this.EventDelay=f&&+f?+f:this.EventDelay;this.popOverStatus=new w;this.init(n)}return e.prototype.hide=function(){var n=this;(sb_ct(this.eventTimer),this.popOverStatus.shouldHide())&&(this.eventTimer=sb_st(function(){n.popOverStatus.shouldHide()&&(n.clearDwellTimers(),n.popOverStatus.windowVisible=!1,n.hideWindow(n.currentSid),n.currentElement=null)},this.EventDelay))},e.prototype.show=function(t){var r=this;(sb_ct(this.eventTimer),this.popOverStatus.shouldShow())&&(this.eventTimer=sb_st(function(){if(r.popOverStatus.shouldShow()){r.popOverStatus.windowVisible=!0;r.currentElement=t;var u=t.getAttribute("data-sid");r.currentSid=u?u:n.Util.getSidFromUrl(t.href);r.container.setAttribute(n.AnchorHookName,t.getAttribute(n.AnchorHookName));r.destinationUrl=t.href;r.sid=u;r.container.href=r.destinationUrl+n.PreviewWindowLinkTrait;r.showContainer();r.container.target=t.target===f?f:"";t.setAttribute("aria-describedby",i)}},this.EventDelay))},e.prototype.hValue=function(){return this.currentElement.getAttribute(n.AnchorHookName)},e.prototype.init=function(t){var i=this;this.container=_ge(t);this.contentPane=_d.getElementsByClassName(h).item(0);this.arrowRightUp=_ge(l);this.arrowRightDown=_ge(v);this.arrowLeftUp=_ge(a);this.arrowLeftDown=_ge(y);sj_be(this.container,r,function(){i.popOverStatus.mouseOnPreviewWindow=!0});sj_be(this.container,u,function(){i.popOverStatus.mouseOnPreviewWindow=!1;i.hide()});sj_be(this.container,n.MouseUpEvent,function(){return i.hideWindow(i.currentSid)});sj_be(_w,s,function(){sb_ct(i.eventTimer);i.clearDwellTimers();i.popOverStatus.windowVisible=!1;i.hideWindow(i.currentSid);i.currentElement=null})},e.prototype.showContainer=function(){sa_cl(this.container,n.HideClassName,!0);this.displayContent(null)},e.prototype.displayContent=function(t,i){if(!i||i===this.currentSid){var r=this.currentElement?this.currentElement.getAttribute(n.HoverHookName):null;this.contentPane.innerHTML="";t==null?r?this._loader.GetContent(r,null,this,!0):this._loader.GetContent(this.destinationUrl,this._psid,this,!1,this.sid):t.innerHTML!=""&&this.currentElement&&(this.contentPane.appendChild(t),this.updateTitlePadding(),this.placeWindow(this.currentElement.getBoundingClientRect()),sa_cl(this.container,n.HideClassName,!1),this.clearDwellTimers(),this.startDwellTimers(),n.Util.LogCiHover("h",this.hValue(),this._containerClassName))}},e.prototype.setTargetElement=function(n){this.popOverStatus.sameEntity=n===this.currentElement;this.popOverStatus.mouseOnLink=n===null?!1:!0},e.prototype.updateTitlePadding=function(){var t,r=_d.getElementsByClassName(n.EpvCaptionClassName),i,u;(r&&r.length>0&&(t=r.item(0)),t)&&(i=t.previousElementSibling,i)&&(t.offsetHeight>=i.offsetHeight&&t.parentElement?t.parentElement.style.height=t.offsetHeight+n.PixelSuffix:(u=(i.offsetHeight-t.offsetHeight)/2,t.style.padding="".concat(u,"px 0")))},e.prototype.startDwellTimers=function(){var t=this;this.dwell2Timer=sb_st(function(){n.Util.LogCiHover("d2",t.currentElement.getAttribute(n.AnchorHookName),t._containerClassName)},this.D2Timeout);this.dwell5Timer=sb_st(function(){n.Util.LogCiHover("d5",t.currentElement.getAttribute(n.AnchorHookName),t._containerClassName)},this.D5Timeout)},e.prototype.clearDwellTimers=function(){sb_ct(this.dwell2Timer);sb_ct(this.dwell5Timer)},e.prototype.hideWindow=function(){this.container.className.indexOf(n.HideClassName)===-1&&sa_cl(this.container,n.HideClassName,!0)},e.prototype.placeWindow=function(i){var f=_w.innerWidth,v=_w.innerHeight,e=i.right-i.left,a=this.container.offsetHeight,o=300,h=15,u=30,y=v-i.bottom,c=0,l=!0,r,s;i.right<o&&i.right<f-i.left?(r=i.right,c=r<u*2?r-u:r<e/2+u*2?r-u:r-e/2-u,l=!1):(r=f-i.left,c=r<u*2?f-o+u-r:r<e/2+u*2?f-o-u:f-r+e/2-o+u);this.container.style.left=c+n.PixelSuffix;this.arrowRightUp.style.visibility=t;this.arrowRightDown.style.visibility=t;this.arrowLeftUp.style.visibility=t;this.arrowLeftDown.style.visibility=t;s=0;this.forceShowingUnderTarget||y>a+h?(s=i.bottom+h,l?this.arrowRightUp.style.visibility="":this.arrowLeftUp.style.visibility=""):(s=i.top-a-h,l?this.arrowRightDown.style.visibility="":this.arrowLeftDown.style.visibility="");this.container.style.top=s+n.PixelSuffix},e}();n.init=d}(EntityPanePreview||(EntityPanePreview={}))