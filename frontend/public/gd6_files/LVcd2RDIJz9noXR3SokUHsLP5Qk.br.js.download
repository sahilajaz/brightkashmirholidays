(function(){var ht,e;try{var i=Microsoft.Maps,n=i.Internal,ti=n.__assign,a=n.__extends,ii=n.__spreadArray,u=i.globalConfig,ri=n.coreConfig,r=u.features,ui=r.advertising,fi=r.autosuggest,ei=r.calendar,oi=r.collections,si=r.directions,hi=r.feedback,ci=r.flyover,li=r.landmarks3D,ai=r.map3D,vi=r.richMapsInfobox,yi=r.labels,pi=r.layerManager,wi=r.localGuide,bi=r.localSearch,ki=r.mapDelay,di=r.optIn,gi=r.print,nr=r.sharing,tr=r.streetside,ir=r.birdseye,rr=r.taskBar,ur=r.taskFramework,fr=r.trafficControl,y=r.traffic,o=r.trafficExperiences,er=r.transit,or=r.travel,sr=r.xsr,hr=atlas.math,cr=atlas.data,lr=atlas.layer,ar=atlas.Pixel,vr=atlas.data.BoundingBox,yr=n.AzureMapEvents,pr=n.AzureMapInteractions,wr=n.Binding,br=n.BoundsAccumulator,kr=n.Debug,rt=n.Gimme,f=n.AtlasHelper,dr=n.EntityHelper,gr=n.Helper,nu=n.LocationRectHelper,ut=n.LocalStorageCache,tu=n.LruCache,ft=n.MapMath,at=n.Network,w=n.JSEvent,iu=n.ObjectWithId,ru=n.Observable,et=n.ObservableCollection,k=n.ObservableObject,uu=n.Overlay,fu=n.PyramidTileSpatialIndex,eu=n.TaskDataHandlerHelper,ou=n.TileSystemHelper,d=n.PerfV2Logger,su=n.VectorMath,vt=n.TimeoutWrapper,hu=i.Anchor,cu=i.BingMapStyle,lu=i.Color,au=i.globalContainer,vu=n.InstrumentationBase,yu=i.LatLonCrs,g=i.Location,pu=i.LatLonEncoder,wu=n.ObservableObjectChangedArgs,bu=i.Point,ku=i.Rectangle,du=i.ResourceManager,gu=i.SimpleAreaPrimitive,nf=i.SimpleLinePrimitive,tf=i.SimplePointPrimitive,rf=i.Size,v=i.Traffic,yt=i.DirectionsControl,u=i.globalConfig,p=i.GlobalDataEventHandler,t=i.ResourceManager.MapDelay,h=i.TrafficControl,nt=n.BaseTask,ot=n.BaseTaskViewModel,uf=n.ControlTemplate,ff=n.Control,pt=n.dependencyResolver,st=n.ExternalPromise,ef=n.MapsInfobox,sf=n.OverlayEntity,tt=v.TrafficPrimitivePopup,wt='<div class="bm_cameraCardRoot" data-tag="cameraCardRoot">    <div class="backArrowDiv cameraBack">            <a class="commonButton backArrowButton trafficBackButton" event:click="onBackClick" href="#" role="button" data-tag="backToProblemTypeSelectButton">                <div class="trafficBackButtonText">                    <TextBlock Text="{Binding resources.L_TrafficBackButtonText}" />                <\/div>            <\/a>    <\/div>    <div class="cameraImgHolder">        <img src="{Binding cameraImageUrl}" style:display="{Binding IsImageError Converter=boolToNotDisplay}" class="cameraImg" data-tag="cameraImg" event:error="onImageError" />        <div style:display="{Binding IsImageError Converter=boolToDisplay}" class="cameraImageError">            <TextBlock Text="{Binding resources.L_CameraImageErrorText}"/>        <\/div>    <\/div>      <div class="copyright">        <TextBlock Text="{Binding copyright}"/>    <\/div>    <div class="cameraDisclaimer" style:display="{Binding disclaimer Converter=nullToDisplayNone}">        <TextBlock Text="{Binding disclaimer}"/>    <\/div><\/div>',bt='<div data-tag="incidentCardRoot">   <div class="backArrowDiv cameraBack">            <a class="commonButton backArrowButton trafficBackButton" event:click="onBackClick" href="#" role="button" data-tag="backToProblemTypeSelectButton">                <div class="trafficBackButtonText">                    <TextBlock Text="{Binding resources.L_TrafficBackButtonText}" />                <\/div>            <\/a>    <\/div>    <div>        <div class="incidentTitleRoot">            <div class="incidentTitle" data-tag="incidentTitle"> <TextBlock Text="{Binding incidentTitle}" /><\/div>            <p class="{Binding severityType Converter=severityTypeToClass}" data-tag="severity"><span><TextBlock Text="{Binding severity}" /><\/span><\/p>        <\/div>        <div class="incidentDescriptionRoot">            <p class="incidentDescription"  data-tag="trafficDescription">            <TextBlock Text="{Binding trafficDescription}" /><\/p>            <p class="incidentTime" data-tag="start">            <span><TextBlock Text="{StaticBinding resources.L_TrafficPopupStartTime_Text}" /><\/span><span><TextBlock Text="{Binding start}" /><\/span><\/p>            <p class="incidentTime" data-tag="end">            <span><TextBlock Text="{StaticBinding resources.L_TrafficPopupEstEndTime_Text}" /><\/span><span><TextBlock Text="{Binding end}" /><\/span><\/p>        <\/div>    <\/div><\/div>',kt='<div data-tag="trafficCardRoot">    <div class="contentRoot trafficCard">        <div class="moduleRoot" data-tag="legendRoot">            <p class="moduleTitle" data-tag="legendTitle" aria-label="{Binding resources.L_TrafficLegendsTitle}" tabindex="0"><TextBlock Text="{Binding resources.L_TrafficLegendsTitle}" /><\/p>            <div class="legendTable" data-tag="legendContainer">                <table role="presentation">                    <tbody>                        <tr>                            <td>                                <div class="tableRow" tabindex="0">                                    <div class="tableCell" aria-label="{Binding resources.L_TrafficLegendsHeavyAriaLabel}">                                        <div class="legendHeavy" data-tag="legendHeavy"><\/div>                                    <\/div>                                    <div class="tableCell">                                        <div data-tag="legendHeavyText"><TextBlock Text="{Binding resources.L_TrafficLegendsHeavy}" /><\/div>                                    <\/div>                                <\/div>                            <\/td>                            <td>                                <div class="tableRow" tabindex="0">                                    <div class="tableCell" aria-label="{Binding resources.L_TrafficLegendsLightAriaLabel}">                                        <div class="legendLight" data-tag="legendLight"><\/div>                                    <\/div>                                    <div class="tableCell">                                        <div data-tag="legendLightText"><TextBlock Text="{Binding resources.L_TrafficLegendsLight}" /><\/div>                                    <\/div>                                <\/div>                            <\/td>                        <\/tr>                        <tr>                            <td>                                <div class="tableRow" tabindex="0">                                    <div class="tableCell" aria-label="{Binding resources.L_TrafficLegendsModerateAriaLabel}">                                        <div class="legendModerate" data-tag="legendModerate"><\/div>                                    <\/div>                                    <div class="tableCell">                                        <div data-tag="legendModerateText"><TextBlock Text="{Binding resources.L_TrafficLegendsModerate}" /><\/div>                                    <\/div>                                <\/div>                            <\/td>                            <td>                                <div class="tableRow" tabindex="0">                                    <div class="tableCell" aria-label="{Binding resources.L_TrafficLegendsNoTrafficAriaLabel}">                                        <div class="legendNoTraffic" data-tag="legendNoTraffic"><\/div>                                    <\/div>                                    <div class="tableCell">                                        <div data-tag="legendNoTrafficText"><TextBlock Text="{Binding resources.L_TrafficLegendsNoTraffic}" /><\/div>                                    <\/div>                                <\/div>                            <\/td>                        <\/tr>                        <tr>                            <td>                                <div class="tableRow" tabindex="0">                                    <div class="tableCell" aria-label="{Binding resources.L_TrafficLegendsClosedAriaLabel}">                                        <div class="legendClosed" data-tag="legendClosed"><\/div>                                    <\/div>                                    <div class="tableCell">                                        <div data-tag="legendClosedText"><TextBlock Text="{Binding resources.L_TrafficLegendsClosed}" /><\/div>                                    <\/div>                                <\/div>                            <\/td>                        <\/tr>                    <\/tbody>                <\/table>            <\/div>        <\/div>    <\/div>    <ItemsControl ItemsSource="{Binding modules}" PanelTagName="ul">        <ItemsControl.ItemTemplate>            <DataTemplate>                <li class="contentRoot trafficCard" style:display="{Binding showModule Converter=boolToDisplay}">                    <div class="moduleRoot recentCameras" data-tag="moduleRoot">                        <p class="moduleTitle" data-tag="moduleTitle"><TextBlock Text="{Binding title}" /><\/p>                        <div>                            <ItemsControl ItemsSource="{Binding collection}" PanelTagName="ul">                                <ItemsControl.ItemTemplate>                                    <DataTemplate>                                        <li class="{Binding incidentType Converter=typeToClass}" data-tag="moduleItem {Binding incidentType Converter=typeToClass}" style:display="{Binding show Converter=boolToDisplay}">                                            <a href="#" event:click="onModuleItemClick" role="button" aria-label="{Binding incidentAriaLabel}">                                                <div style:display="{Binding incidentType Converter=cameraTypeToDisplay}">                                                    <div class="camPreviewPlaceHolder" data-tag="imgPreviewPlaceHolder">                                                        <img src="{Binding cameraImageUrl}" alt="{Binding altDescription}" class="imgPreview" style:display="{Binding IsImageReady Converter=boolToDisplay}" event:error="onImageError" />                                                        <video loop="" muted="" autoplay="" src="{Binding cameraVideoUrl}" id="{Binding videoPreviewId}" class="videoPreview" style:display="{Binding IsVideoReady Converter=boolToDisplay}" alt="{Binding altDescription}" />                                                    <\/div>                                                    <div class="cameraTitle" data-tag="cameraTitle">                                                        <TextBlock Text="{Binding incidentTitle}" />                                                    <\/div>                                                <\/div>                                                <div style:display="{Binding incidentType Converter=incidentTypeToDisplay}" class="incidentContainer" data-tag="incidentContainer">                                                    <div class="tableCell">                                                        <div class="{Binding incidentType Converter=incidentTypeToIconClass}" data-tag="incidentIcon"><\/div>                                                    <\/div>                                                    <div class="tableCell">                                                        <div class="trafficDescriptionText" data-tag="incidentTrafficDescription"><TextBlock Text="{Binding trafficDescription}" /><\/div>                                                        <div class="trafficDescriptionText" data-tag="incidentSeverity"><TextBlock Text="{Binding severity}" /><\/div>                                                    <\/div>                                                <\/div>                                            <\/a>                                            <a href="#" class="removeRecentCamera" role="button" event:click="onRemoveRecentCameraClick" aria-label="{Binding removeCameraAriaLabel}" data-tag="removeRecentCameraLink">                                            <\/a>                                        <\/li>                                    <\/DataTemplate>                                <\/ItemsControl.ItemTemplate>                            <\/ItemsControl>                        <\/div>                        <a href="#" class="removeAllRecentCameras" event:click="onRemoveAllRecentCamerasClick" data-tag="removeAllRecentCamerasLink" role="button">                            <div class="removeAllRecentCamerasText" data-tag="removeAllRecentCamerasText"><TextBlock Text="{Binding resources.L_TrafficRemoveAllRecentCamerasLink}" /><\/div>                        <\/a>                        <a href="#" class="moreLink" style:display="{Binding showMoreLink Converter=boolToDisplay}" event:click="onMoreClick" data-tag="moreLink" role="button">                            <div class="moreLinkText" data-tag="moreLinkText"><TextBlock Text="{Binding moreLinkText}" /><\/div>                            <div data-tag="arrow" class="{Binding arrowClass}"><\/div>                        <\/a>                        <div class="clear"><\/div>                    <\/div>                <\/li>            <\/DataTemplate>        <\/ItemsControl.ItemTemplate>    <\/ItemsControl>    <div class="clear"><\/div>    <ItemsControl ItemsSource="{Binding trafficSettings}">        <ItemsControl.ItemTemplate>            <DataTemplate>                <div class="trafficSettings" tabindex="0" event:keyup="onKeyUp" event:click="onClick" role="checkbox" aria-checked="{Binding ariaChecked}">                    <div class="switchSlot labelToggle" for="{Binding inputId}">                        <div class="labelToggle_Container labelStyle">                            <div class="labelStyleSwitch" id="toggleSwitchLabel" title="{Binding label}" data-tag="{Binding switchDataTag}">                                <input id="{Binding inputId}" type="checkbox" class="labelToggle_Input" checked="checked" tabindex="-1" aria-hidden="true" aria-labelledby="{Binding toggleUniqueId}" aria-checked="{Binding ariaChecked}" />                                <label class="labelToggle_label" id="{Binding toggleUniqueId}">                                    <TextBlock Text="{Binding label}" />                                <\/label>                            <\/div>                        <\/div>                    <\/div>                    <div class="trafficToggleNotification" data-tag="{Binding notificationDataTag}">                        <TextBlock Text="{Binding notification}" />                    <\/div>                <\/div>            <\/DataTemplate>        <\/ItemsControl.ItemTemplate>    <\/ItemsControl>    <\/div>',dt='<div data-tag="trafficCardRoot">    <div id="trafficExperienceContainer"><\/div><\/div>';ht=function(n){function t(t){var i=n.call(this)||this;return i.type="TrafficFlipTask",i._controlTemplateFactory=t,i.displayState={colorIndex:6,groupName:"Traffic"},i}return a(t,n),t.prototype.activate=function(i,r){var u,f;r&&(this._taskState=r,u=r.incident,u&&u.type===12&&(this._taskState.location=new g(u.point.coordinates[0],u.point.coordinates[1]),this._taskState.description=u.description));this.setTitle(this._taskState.incident.description);n.prototype.activate.call(this,i,r);s.trafficTaskId=this.id;f=this._viewModel=new b(this._controlTemplateFactory,this._taskState.incident,i);this.addControl(f.getControl());t.trafficTaskId=this.id;this._taskState.incident.type===12&&(c.saveIncident(this._taskState.incident),s.mostRecentCameras.push(f));this.setPercentLoaded(1)},t.close=function(){var n={action:"remove",id:t.trafficTaskId};p.invokeHandler("data-task",n)},t.prototype.processCallback=function(){},t.prototype.serialize=function(){return this._taskState},t.prototype.setDisplayState=function(i){n.prototype.setDisplayState.call(this,i);t.trafficTaskId=this.id},t.prototype.getMenuList=function(){return[]},t.prototype.getCardIconInfo=function(){return{iconClass:"trfkTsk"}},t.prototype.isSharable=function(){return!1},t.prototype.hasDefaultFocusElement=function(){return!0},t}(nt),function(n){function i(n,i){var r={logData:{feature:t,action:n,data:i}};p.invokeHandler("data-instrumentation",r)}function r(){p.invokeHandler("data-serverInstrumentation",{logData:{feature:"trfc",data:"traffic"}})}var t="T";n.logInstrumentationEvent=i;n.callMapSnRInstrumentation=r}(e||(e={}));var gt=function(n){function t(t,i){var r=n.call(this)||this;return r._privates.defineProperty("isShowing",null,null,{defaultValue:!1}),r._map=t,r._perfLog=i,r._flowManager=new h.TrafficFlowManager(t.getAzureMap(),r._setTrafficFlowLayerMetadata),r._disposables=[r._flowManager,r.recentCamerasUpdated=new w,r.primitivesUpdated=new w],r._createIncidentManager(),r._onLoadTrafficLayerStatus=!1,h.instrumentationHelper=e,r}return a(t,n),t.prototype.getFlowManager=function(){return this._flowManager},t.prototype.getIncidentManager=function(){return this._incidentManager},t.prototype.show=function(n,t){var r,i;(!this.getIsShowing()||u.trafficStyleMenu||u.trafficStyleMenu2)&&(this.setIsShowing(!0),r=void 0,this._perfLog&&(r=this._perfLog.start("T_LD")),!this._onLoadTrafficLayerStatus&&(u.trafficStyleMenu||u.trafficStyleMenu2)&&(sj_evt.fire("OnLoadTrafficLayerStatus"),t=!0,this._onLoadTrafficLayerStatus=!0),(!s.isCardShowing&&(u.isMapsVertical||f._isMapsOverlay())||t)&&(i={},s.isCardShowing&&(i.action="focus"),i.type="TrafficTask",i.id=s.trafficTaskId,p.invokeHandler("data-task",i),s.isCardShowing=!0),(!o.isEnabled||t)&&this.showTrafficMapLayer(),e.logInstrumentationEvent("A",{EP:n,C:!0}),(n===1||n===3)&&e.callMapSnRInstrumentation());(!o.isEnabled||t)&&this.showPrimitiveLayer()},t.prototype.hide=function(n,t,i,r){var h=u.trafficStyleMenu||u.trafficStyleMenu2;(this.getIsShowing()||i||h)&&(this.setIsShowing(!1),o.isEnabled||r||(this.hideTrafficMapLayer(),this.hidePrimitiveLayer()),c.commitChanges(),!n&&s.isCardShowing&&(u.isMapsVertical||f._isMapsOverlay())&&(s.close(),sj_evt.fire("ClosedTrafficCard")),e.logInstrumentationEvent("D",{}))},t.prototype.toggle=function(n){this.getIsShowing()?this.hide():this.show(n)},t.prototype.toggleCameras=function(n){this._incidentManager&&(n?this._incidentManager.showCameras():this._incidentManager.hideCameras());e.logInstrumentationEvent("TC",{CTO:n})},t.prototype.toggleTrafficAnimation=function(n){n?this._flowManager.showAnimation():this._flowManager.hideAnimation()},t.prototype.getCamerasHidden=function(){var n;if((n=this._incidentManager)!==null&&n!==void 0)return n.areCamerasHidden()},t.prototype.hidePrimitiveLayer=function(){var n;(n=this._incidentManager)===null||n===void 0?void 0:n.hide()},t.prototype.showPrimitiveLayer=function(){this._updateRecentCameras();this._incidentManager.show()},t.prototype.addAlwaysShownPins=function(n){n&&this._incidentManager.addAlwaysShownPins(n)},t.prototype.removeAlwaysShownPins=function(n){n&&this._incidentManager&&this._incidentManager.removeAlwaysShownPins(n)},t.prototype.hideTrafficMapLayer=function(){(u.trafficStyleMenu||u.trafficStyleMenu2)&&this.setIsShowing(!1);this._flowManager.showAnimation();this._flowManager.hideFlow()},t.prototype.showTrafficMapLayer=function(){(u.trafficStyleMenu||u.trafficStyleMenu2)&&this.setIsShowing(!0);this._flowManager.showFlow()},t.prototype.setOpacity=function(n){this._flowManager.setOpacity(n)},t.prototype.incidentLayerHasCameras=function(){var n;if((n=this._incidentManager)!==null&&n!==void 0)return n.hasCamera()},t.prototype.setPrimitiveStates=function(n,t){if(this._incidentManager){t===1&&this._incidentManager.resetPrimitive(!1);var i=n===1?2:5;u.trafficStyleMenu||u.trafficStyleMenu2?this._incidentManager.setPrimitiveStates(2):this._incidentManager.setPrimitiveStates(i)}},t.prototype.dispose=function(){this._incidentManager=null;this._perfLog=null;n.prototype.dispose.call(this);f._clearDisposables(this._disposables)},t.prototype._createIncidentManager=function(){var t=this,n;this._incidentManager||(n=this._incidentManager=new h.TrafficIncidentManager(this._map.getAzureMap()),this._disposables.push(n,n.incidentClicked.add(function(n){return t._onPrimitiveSelected(n)}),n.incidentsUpdated.add(function(){return t.primitivesUpdated.invoke()})))},t.prototype._setTrafficFlowLayerMetadata=function(n,t){t&&(n.metadata={noPrint:!0})},t.prototype._updateRecentCameras=function(){var n=this._incidentManager,t,i;n&&(t=l.recentCameraVMs||[],i=t.map(function(n){return n.pin}),n.setRecentCameras(i),n.isShowing()&&n.show())},t.prototype._onPrimitiveSelected=function(n){if(!o.isEnabled){var t=n.incident,i=h.isCamera(t);i&&this.recentCamerasUpdated&&(this.recentCamerasUpdated.invoke(t),c.saveIncident(t),this._updateRecentCameras())}},t}(k),c=function(){function n(){}return n.saveIncident=function(t){var r,i,u;if(n.getIncidents(),n.recentlyUsed){for(r=-1,i=0;i<n.recentlyUsed.length;i++)if(u=n.recentlyUsed[i],u.description===t.description){r=i;break}r!==-1?n.recentlyUsed.splice(r,1):n.recentlyUsed.length===n.Max_limit&&n.recentlyUsed.splice(0,1);n.recentlyUsed.push(t)}n.commitChanges()},n.commitChanges=function(){var r,i,t,u;if(n.recentlyUsed){for(r="",i=0;i<n.recentlyUsed.length;i++)t=n.recentlyUsed[i],t.usedCount||(t.usedCount=0),u=n.SerializedCameraFormat.replace("{lat}",t.point.coordinates[0].toString()).replace("{long}",t.point.coordinates[1].toString()).replace("{description}",t.description).replace("{usage}",t.usedCount.toString()),i!==n.recentlyUsed.length-1&&(u+="$"),r+=u;ut.setItem(n.TrafficLocalStorageKey,r)}},n.getIncidents=function(){var r,u,i,t,f;if(!n.recentlyUsed&&(r=ut.getItem(n.TrafficLocalStorageKey),n.recentlyUsed=[],r))for(u=r.split("$"),i=0;i<u.length;i++)t=u[i].split("|"),f={point:{coordinates:[parseFloat(t[0]),parseFloat(t[1])]},description:t[2],usedCount:parseInt(t[3]),recentlyUsed:!0,type:12},n.recentlyUsed.push(f);return n.recentlyUsed},n.removeIncident=function(t){var i,r;if(n.recentlyUsed){for(i=0;i<n.recentlyUsed.length;i++)if(r=n.recentlyUsed[i],r.description===t.description){n.recentlyUsed.splice(i,1);break}n.commitChanges()}},n.removeAllIncidents=function(){n.recentlyUsed&&(n.recentlyUsed.splice(0,n.recentlyUsed.length),n.commitChanges())},n.TrafficLocalStorageKey="TrafficCameras",n.Max_limit=10,n.SerializedCameraFormat="{lat}|{long}|{description}|{usage}",n}(),l=function(n){function i(r,e,s,h,c){var l=this,a=kt,v;return o.isEnabled&&(a=dt),l=n.call(this,r,a)||this,l._map=e,l.resources=t,l._controlTemplateFactory=r,l.modules=new et,l._maxRecentlyUsedCamerasPreviews=4,v=e.getView().zoom<=f.convertZoom(y.minZoomForAllCameras,1)?t.L_TrafficsZoomInNotification:null,o.isEnabled?l.trafficSettings=[]:(l.camerasToggle=new ct("camToggle",c,t.L_TrafficsToggleCameras,v,function(n){s&&s.invoke(n);l.updateCameraMessage(!0)}),l.trafficSettings=[l.camerasToggle,new ct("aniToggle",c,t.L_TrafficToggleAnimation,null,function(n){h&&h.invoke(n)})]),(f._isMapsOverlay()||u.isMapsVertical)&&(i.recentCamerasModule=new it(l._map,l._maxRecentlyUsedCamerasPreviews,t.L_TrafficRecentCamerasTitle),l.modules.insert(i.recentCamerasModule)),l}return a(i,n),i.prototype.initializeRecentCameras=function(){var n,t,r,e,o;if(f._isMapsOverlay()||u.isMapsVertical){if(i.recentCameraVMs=[],n=c.getIncidents(),n&&n.length)for(t=0,r=n;t<r.length;t++)e=r[t],o=new b(this._controlTemplateFactory,e,this._map),o.pin=h.createIncidentPrimitive(e),i.recentCameraVMs.unshift(o);this.updateCameraImages()}},i.prototype.updateRecentCameras=function(){for(var r,u,n=0,t=s.mostRecentCameras;n<t.length;n++)r=t[n],u=i.findExistingRecentCamera(r.incidentData),u>=0&&i.recentCameraVMs.splice(u,1),i.recentCameraVMs.unshift(r);i.recentCameraVMs=i.recentCameraVMs.slice(0,c.Max_limit);this.updateCameraImages();s.mostRecentCameras=[]},i.prototype.addCameraToRecentCameras=function(n){var r=i.findExistingRecentCamera(n),t;r>=0&&i.recentCameraVMs.splice(r,1);n.type=12;t=new b(this._controlTemplateFactory,n,this._map);t.pin=h.createIncidentPrimitive(n);i.recentCameraVMs.unshift(t);i.recentCameraVMs=i.recentCameraVMs.slice(0,c.Max_limit);this.updateCameraImages()},i.prototype.updateCameraImages=function(){var r,n,e,t;if(f._isMapsOverlay()||u.isMapsVertical){for(i.recentCamerasModule.collection.clear(),r=[],n=0,e=i.recentCameraVMs;n<e.length;n++)t=e[n],h.incidentWithinMap(this._map.getAzureMap(),t.incidentData)?i.recentCamerasModule.collection.insert(t):r.push(t);i.recentCamerasModule.collection.insertAll(r)}},i.findExistingRecentCamera=function(n){for(var r,u,t=0;t<i.recentCameraVMs.length;t++)if(r=i.recentCameraVMs[t],u=r.pin&&r.pin.incident,u&&n.description&&u.description===n.description)return t;return-1},i.prototype.typeToClass=function(n){return n===12?"bm_moduleItem":"bm_moduleItem notificationItem"},i.prototype.incidentTypeToIconClass=function(n){switch(n){case 9:return"notification construction";case 1:return"notification accident";default:return"notification otherincident"}},i.prototype.cameraTypeToDisplay=function(n){return n===12?"":"none"},i.prototype.incidentTypeToDisplay=function(n){return n!==12?"":"none"},i.prototype.updateCameraMessage=function(n){var i=this;this._map.getContainer().instanceAsync("TrafficLayerV2",function(r){var e=r.incidentLayerHasCameras(),u=i.camerasToggle;u.getEnabled()?i._map.getView().zoom<=f.convertZoom(y.minZoomForAllCameras,1)?u.setNotification(t.L_TrafficsZoomInNotification):n||e?u.setNotification(null):u.setNotification(t.L_TrafficsNoCameraNotification):u.setNotification(null)})},i.prototype.dispose=function(){this._routeIdOnMap&&yt.clearRoute(this._routeIdOnMap);n.prototype.dispose.call(this)},i.recentCameraVMs=[],i}(ot),s=function(n){function r(t,i,u,f,s){var c=n.call(this,u)||this;return c.type="TrafficTask",r.controlTemplateFactory=t,c._cameraListenerAdded=!1,r.isCardShowing=!1,c._reverseGeocoder=f,c._geocoder=s,c._flowManagerPromise=new st,c._incidentManagerPromise=new st,tt.initialize(u.getAzureMap()),h.instrumentationHelper=e,c.displayState={colorIndex:6,groupName:"Traffic"},i.instanceAsync("TrafficLayerV2",function(n){c._trafficLayer=n;o.isEnabled?(c._flowManagerPromise.resolve(c._trafficLayer.getFlowManager()),c._incidentManagerPromise.resolve(c._trafficLayer.getIncidentManager())):(c._taskState&&c._trafficLayer.show(3),c._trafficLayer.toggleCameras(!0));c._addTrafficLayerEventListeners()}),c.disposables=[c.camerasToggled=new w,c.animationToggled=new w,c.camerasToggled.add(function(n){c._trafficLayer&&c._trafficLayer.toggleCameras(n)}),c.animationToggled.add(function(n){c._trafficLayer&&c._trafficLayer.toggleTrafficAnimation(n)})],c}return a(r,n),r.prototype.activate=function(u,e){var s=this,c,h;r.isCardShowing=!0;c=o.trafficTimesConfigs.isEnabled?t.L_TrafficTaskTitle_Text:t.L_TrafficTaskNewsAndEventsTitle_Text;this.setTitle(c);this._taskState=e||{taskTitle:this.getTitle()};n.prototype.activate.call(this,u,e);r.trafficTaskId=this.id;this._viewModel=new l(r.controlTemplateFactory,u,this.camerasToggled,this.animationToggled,this.id);this.addControl(this._viewModel.getControl());this._map=u;this._viewModel.initializeRecentCameras();this._taskState&&this._trafficLayer&&this._trafficLayer.show(3);this._addTrafficLayerEventListeners();o.isEnabled&&(h=this._map.getAzureMap(),pt.resolveBySourceKey("TrafficExperiences",function(){vt.setTimeout(function(){if(r.isCardShowing){i.TrafficExperiences.initialize({atlasMap:h,flowManager:s._flowManagerPromise,incidentManager:s._incidentManagerPromise,reverseGeocoder:s._reverseGeocoder,geocoder:s._geocoder,taskChanged:s.changed,taskActivationState:s.displayState.activationState});var n=d.getStartTime(s.id,!0)||d.getStartTime("SearchRequest",!0);n&&d.logAfterRenderComplete("Maps_TTTG",n);s._trafficLayer.show(3)}},1)}),this._trafficTogglesControl=new ni,h.controls.add(this._trafficTogglesControl,{position:atlas.ControlPosition.NonFixed}));f._isCommuteDashboardPage()&&u.getStreetsideControl().then(function(n){n.getCoverage().autoCoverage(!1)});this.setPercentLoaded(1)},r.prototype.deactivate=function(){var t;n.prototype.deactivate.call(this);this._trafficLayer.hide();o.isEnabled&&(i.TrafficExperiences.dispose(),this._map.getAzureMap().controls.remove(this._trafficTogglesControl),this._trafficLayer.hide());(t=this._viewModel)===null||t===void 0?void 0:t.dispose()},r.close=function(){r.isCardShowing=!1;var n={action:"remove",id:r.trafficTaskId};p.invokeHandler("data-task",n)},r.prototype.processCallback=function(){},r.prototype.serialize=function(){return this._taskState},r.prototype.setDisplayState=function(t){var o,s,e,h,c;if(n.prototype.setDisplayState.call(this,t),r.trafficTaskId=this.id,t.activationState&&t.prominence){for((o=this._trafficLayer)===null||o===void 0?void 0:o.show(3),e=0,h=this._viewModel.trafficSettings;e<h.length;e++)c=h[e],c.toggleCallback(c.getEnabled());r.mostRecentCameras&&r.mostRecentCameras.length&&(f._isMapsOverlay()||u.isMapsVertical)&&this._viewModel&&this._viewModel.updateRecentCameras();t.activationState!==1||t.prominence!==1||((s=i.Local)===null||s===void 0?void 0:s.LocalSearchTask)||nt._removeCardPrimerBase()}this._trafficLayer&&(t.prominence===3&&this._trafficLayer.hide(!0),this._trafficLayer.setPrimitiveStates(t.activationState,1))},r.prototype.getMenuList=function(){return[]},r.prototype.getCardIconInfo=function(){return{iconClass:"trfkTsk"}},r.prototype.isSharable=function(){return!0},r.prototype.hasDefaultFocusElement=function(){return!1},r.prototype._addTrafficLayerEventListeners=function(){var n=this;this._trafficLayer&&this._viewModel&&(this._cameraListenerAdded||(this.disposables.push(this._trafficLayer.recentCamerasUpdated.add(function(t){n._viewModel.addCameraToRecentCameras(t)})),this._cameraListenerAdded=!0),this._primitivesUpdatedListenerAdded||(this.disposables.push(this._trafficLayer.primitivesUpdated.add(function(){var t;o.isEnabled||n._viewModel.updateCameraMessage();(t=n._trafficLayer)===null||t===void 0?void 0:t.setPrimitiveStates(n.displayState.activationState,0)})),this._primitivesUpdatedListenerAdded=!0))},r.mostRecentCameras=[],r}(nt),ni=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return a(t,n),t.prototype.onAdd=function(n){return this.togglesContainer=this.buildContainer(n,atlas.ControlStyle.auto),this.togglesContainer.className="bm_trafficToggles",this.togglesContainer},t.prototype.getRootElement=function(){return this.togglesContainer},t}(atlas.control.ControlBase),b=function(n){function i(i,r,u){var f=this,o=r.recentlyUsed||r.type===12?wt:bt,e;return f=n.call(this,i,o)||this,f._map=u,f.resources=t,e=f._privates,e.defineProperty("cameraImageUrl"),e.defineProperty("cameraVideoUrl"),e.defineProperty("isImageReady"),e.defineProperty("isVideoReady"),f.setIncident(r),e.defineProperty("show",null,null,{defaultValue:!1}),r.type!==12||r.images||f.getCamera(),f}return a(i,n),i.prototype.setIncident=function(n){var i=this;this.incidentType=n.type;this.incidentData=n;this.pin&&(this.pin.incident=n);this.incidentId=n.incidentId;this.point=n.point;this.copyright=n.copyright;this.trafficDescription=n.description;n.recentlyUsed||n.images&&n.images.length>0?(this.incidentTitle=n.description,this.cameraDirection=n.view,n.images&&n.images.length&&(this.setIsImageReady(!1),this.setIsVideoReady(!1),this.videoPreviewId="videoPreview_".concat(this.incidentId),tt.getCameraVisualUrl(n,!1,function(n,t,r){return i._onCameraVisualResponse(t,r)}),this.altDescription=t.L_TrafficPreviewCameraImage_Text.replace("{0}",n.description),this.removeCameraAriaLabel=t.L_TrafficRemoveRecentCameraToolTip_Text.replace("{0}",n.description),this.incidentAriaLabel=t.TrafficCameraAriaLabel.replace("{0}",n.description)),y.showCameraDisclaimer&&(this.disclaimer=t.L_TrafficCameraDisclaimer_Text)):(this.end=n.isEndTimeBackfilled?t.L_IncidentEndTimeUnknown_Text:this._getFormattedDateTime(n.end),this.roadClosed=n.roadClosed,this.severityType=n.severity,this.severity=this._getSeverityTitle(n.severity),this.start=this._getFormattedDateTime(n.start),this.toPoint=n.toPoint,this.verified=n.verified,this.incidentTitle=this.roadClosed&&n.type===5?t.L_TrafficRoadClosed_Text:this._getIncidentTypeTitle(n.type))},i.prototype.severityTypeToClass=function(n){return i.ConvertSeverityTypeToClass(n)},i.ConvertSeverityTypeToClass=function(n){switch(n){case 4:return"incidentSeverity high";case 3:return"incidentSeverity moderate";default:return"incidentSeverity mild"}},i.prototype.onImageError=function(){this.setIsImageReady(!1);var n={IID:this.incidentData.incidentId.toString()};e.logInstrumentationEvent("TCF",n)},i.prototype.onBackClick=function(n){n.preventDefault()},i.prototype.onModuleItemClick=function(n){var r,u;n.preventDefault();var t=this.incidentData.point.coordinates,i=this._map.getView().zoom,o=[t[1],t[0]];h.incidentWithinMap(this._map.getAzureMap(),this.incidentData)||(r=Math.max(f.convertZoom(y.minZoomLevelToShowIncidents,1),i),this._map.setView({zoom:r,center:o}));tt.show(this.pin);u={IUT:5,Z:i};e.logInstrumentationEvent("ID",u)},i.prototype.onRemoveRecentCameraClick=function(n){n.preventDefault();it.removeCamera(this,this._map)},i.prototype._onCameraVisualResponse=function(n,t){if(n)if(t){this.setIsVideoReady(!0);this.setCameraVideoUrl(n);var i=rt("#".concat(this.videoPreviewId))[0];i&&(i.muted=!0)}else this.setIsImageReady(!0),this.setCameraImageUrl(n)},i.prototype._getIncidentTypeTitle=function(n){if(n)switch(n){case 9:return t.L_TrafficScheduledConstruction_Text;case 6:return t.L_TrafficOtherNews_Text;case 2:return t.L_TrafficCongestion_Text;case 1:return t.L_TrafficAccident_Text;case 3:return t.L_TrafficDisabledVehicle_Text;case 8:return t.L_TrafficRoadHazard_Text;case 10:return t.L_TrafficUnScheduledContruction_Text;case 7:return t.L_TrafficPlannedEvent_Text;case 4:return t.L_TrafficMassTransit_Text;case 11:return t.L_TrafficWeather_Text;case 5:return t.L_TrafficMiscellaneous_Text;default:return""}return""},i.prototype._getSeverityTitle=function(n){switch(n){case 1:return t.L_TrafficSeverityLowImpact_Text;case 2:return t.L_TrafficSeverityMinor_Text;case 3:return t.L_TrafficSeverityModerate_Text;case 4:return t.L_TrafficSeveritySerious_Text;default:return""}},i.prototype._getFormattedDateTime=function(n){var u="",e,i,r;return n&&(e=/\(([\d]+)\)/,i=e.exec(n),i&&i.length>1&&(r=new Date(parseInt(i[1],10)),u=f._formatString(t.L_TrafficDateTimeFormat,f._formatShortDateString(r),f._formatTimeString(r)))),u},i.prototype.getCamera=function(){var t=this,n=this.incidentData,i=ft.getMapLocationFromLocationHeadingAndDistance(new g(n.point.coordinates[0],n.point.coordinates[1]),Math.PI*3/4,5),r=ft.getMapLocationFromLocationHeadingAndDistance(new g(n.point.coordinates[0],n.point.coordinates[1]),Math.PI*7/4,5),f=i.latitude+","+r.longitude+","+r.latitude+","+i.longitude,e=u.dynamicProperties.sessionKey,o=y.cameraByLocationUrlFormat.replace("{bounds}",f).replace("{credentials}",e);at.downloadJsonp(o,"trfcam",function(n,i){return t._processCameraDetails(n,i)},function(n){return t._processErrors(n)},null,!1,{})},i.prototype._processCameraDetails=function(n){var r=n.resourceSets&&n.resourceSets.length>0&&n.resourceSets[0].resources||[],u=this.incidentData,f=!1,i,t;if(r.length)for(i=0;i<r.length;i++)if(t=r[i],t.description===u.description){t.recentlyUsed=u.recentlyUsed;this.setIncident(t);this.pin&&(this.pin.incident=t);f=!0;break}f||it.removeCamera(this,this._map)},i.prototype._processErrors=function(){},i}(ot),it=function(n){function i(i,r,u){var f=n.call(this)||this,e;return f._map=i,f.resources=t,f.collection=new et,f.collection.changed.add(function(){f._onCollectionChanged()}),e=f._privates,e.defineProperty("showModule",null,null,{defaultValue:!1}),e.defineProperty("showMoreLink",null,null,{defaultValue:!1}),e.defineProperty("moreLinkText",null,null,{defaultValue:t.L_TrafficModuleMoreLink}),e.defineProperty("arrowClass",null,null,{defaultValue:"downArrow trafficArrow"}),f.title=u,f._maxItemsPreviews=r,f}return a(i,n),i.prototype.onMoreClick=function(n){var r,u;n.preventDefault();var i=this.getMoreLinkText()===t.L_TrafficModuleMoreLink,f=this.collection.length>this._maxItemsPreviews,o=i?t.L_TrafficModuleLessLink:t.L_TrafficModuleMoreLink,s=i?"upArrow trafficArrow":"downArrow trafficArrow";if(f)for(this.setMoreLinkText(o),this.setArrowClass(s),r=this._maxItemsPreviews;r<this.collection.length;r++)this.collection[r].setShow(i);this.title===t.L_TrafficRecentCamerasTitle&&(u=1);e.logInstrumentationEvent("ML",{M:u,ILM:i})},i.prototype._onCollectionChanged=function(){var i,n;if(this.collection.length)for(this.getShowModule()||this.setShowModule(!0),this.setShowMoreLink(this.collection.length>this._maxItemsPreviews),i=this.getMoreLinkText()===t.L_TrafficModuleMoreLink,n=0;n<this.collection.length;n++)this.collection[n].setShow(!(n>=this._maxItemsPreviews&&i));else this.setShowModule(!1)},i.prototype.onRemoveAllRecentCamerasClick=function(n){n.preventDefault();i.removeAllCameras();i._refreshMapView(this._map)},i._refreshMapView=function(n){n.getContainer().instanceAsync("TrafficLayerV2",function(n){n.getCamerasHidden()||n.showPrimitiveLayer()})},i.removeAllCameras=function(){l.recentCamerasModule.collection.clear();l.recentCameraVMs.splice(0,l.recentCameraVMs.length);c.removeAllIncidents()},i.removeCamera=function(n,t){if(n){c.removeIncident(n.incidentData);var r=l.recentCameraVMs;r&&l.recentCamerasModule&&(l.recentCamerasModule.collection.remove(n),l.recentCameraVMs=r.filter(function(t){return t.id!==n.id}));i._refreshMapView(t)}},i}(k),ct=function(n){function t(t,i,r,u,f){var e=n.call(this)||this,o=e._privates;return o.defineProperty("enabled",function(n,t){f&&f(t)},null,{defaultValue:!0}),o.defineProperty("notification",null,null,{defaultValue:u}),o.defineProperty("ariaChecked",null,null,{defaultValue:!0}),o.defineProperty("toggleUniqueId",null,null,{defaultValue:"".concat(t,"_ToggleUniqueId_").concat(i)}),e.inputId="".concat(t,"_InputId"),e.label=r,e.switchDataTag="".concat(t,"_switch"),e.notificationDataTag="".concat(t,"_notification"),e.toggleCallback=f,e}return a(t,n),t.prototype.onKeyUp=function(n){var t=n,i=t.keyCode||t.which;i===13&&this._onToggled()},t.prototype.onClick=function(n){n.stopPropagation();this._onToggled()},t.prototype._onToggled=function(){var n=!this.getEnabled(),t=rt("#".concat(this.inputId))[0];t.checked=n;this.setAriaChecked(n);this.setEnabled(n)},t}(k),v=i.Traffic=i.Traffic||{};v.TrafficLayerV2=gt;v.TrafficTask=s;v.TrafficFlipTask=ht;v.IncidentViewModel=b;v.TrafficInstrumentationHelper=e;v.TrafficLocalStorageHelper=c}catch(lt){if(i&&i.logger)i.logger.logCriticalError(lt);else throw lt;}}).call(window)